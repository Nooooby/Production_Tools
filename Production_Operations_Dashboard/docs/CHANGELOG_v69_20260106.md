# 变更记录 v69 - 建立中间表替代硬编码

**日期**: 2026-01-06  
**版本**: v68 → v69  
**目标**: 替换 14_Production_Planning 中的复杂 SUMPRODUCT 公式为中间表方案

---

## 📋 解决的问题

### 问题背景
在 v68 中，`14_Production_Planning` 的 Demand 区域（Row 30-38）使用了复杂的 SUMPRODUCT 公式来汇总需求：
```excel
=IFERROR(SUMPRODUCT((INDEX('00_SKU_Master'!$E$2:$E$2000,MATCH('02_TrayPack_Order'!$B$3:$B$301,'00_SKU_Master'!$B$2:$B$2000,0))=A35)*'02_TrayPack_Order'!$D$3:$D$301),0)
```

### 问题分析
1. **公式过于复杂**：涉及 INDEX、MATCH、SUMPRODUCT 嵌套
2. **维护困难**：每次修改需要同时更新 TrayPack、BulkPack、Bagging 三个公式
3. **性能问题**：每个 Product_Group 需要扫描 00_SKU_Master 和订单表
4. **错误风险**：公式可能在复制时出错（例如 ArrayFormula 对象问题）

---

## ✅ 实施方案：建立中间表

### 新增：`14_Demand_Aggregation` 工作表

#### 结构
| 列 | 说明 | 公式示例（BA 为例）|
|----|------|-------------------|
| A | Product_Group | BA |
| B | TrayPack_WIP_kg | `=SUMIF('02_TrayPack_Order'!$P$3:$P$300,A10,'02_TrayPack_Order'!$R$3:$R$300)` |
| C | BulkPack_WIP_kg | `=SUMIF('03_BulkPack_Order'!$K$3:$K$300,A10,'03_BulkPack_Order'!$N$3:$N$300)` |
| D | Bagging_WIP_kg | `=SUMIF('04_Bagging_Order'!$N$3:$N$300,A10,'04_Bagging_Order'!$Q$3:$Q$300)` |
| E | Total_WIP_kg | `=B10+C10+D10` |

#### 包含的 Product_Groups
1. SplitBreast
2. BSB
3. Fillet
4. Wing
5. SplitWing
6. BA
7. Thigh
8. ThighMeat
9. Drum
10. Backbone
11. WingTip
12. Whole Bird-Small
13. Whole Bird-Large

---

## 🔄 更新：`14_Production_Planning` 公式

### 原公式（复杂的 SUMPRODUCT）
```excel
B35: =IFERROR(SUMPRODUCT((INDEX('00_SKU_Master'!$E$2:$E$2000,MATCH('02_TrayPack_Order'!$B$3:$B$301,'00_SKU_Master'!$B$2:$B$2000,0))=A35)*'02_TrayPack_Order'!$D$3:$D$301),0)
```

### 新公式（简洁的 INDEX-MATCH）
```excel
B35: =IFERROR(INDEX('14_Demand_Aggregation'!$B$5:$B$100,MATCH(A35,'14_Demand_Aggregation'!$A$5:$A$100,0)),0)
C35: =IFERROR(INDEX('14_Demand_Aggregation'!$C$5:$C$100,MATCH(A35,'14_Demand_Aggregation'!$A$5:$A$100,0)),0)
D35: =IFERROR(INDEX('14_Demand_Aggregation'!$D$5:$D$100,MATCH(A35,'14_Demand_Aggregation'!$A$5:$A$100,0)),0)
```

### 更新范围
- **Row 30**: SplitBreast (B30, C30, D30)
- **Row 31**: BSB (B31, C31, D31)
- **Row 32**: Fillet (B32, C32, D32)
- **Row 33**: Wing (B33, C33, D33)
- **Row 34**: SplitWing (B34, C34, D34)
- **Row 35**: BA (B35, C35, D35) ← **关键验证点**
- **Row 36**: Thigh (B36, C36, D36)
- **Row 37**: ThighMeat (B37, C37, D37)
- **Row 38**: Drum (B38, C38, D38)

---

## 🎯 优势

### 1. 简化维护
- 中间表使用简单的 SUMIF 公式
- 修改时只需在一个地方更新
- 14_Production_Planning 只需用 INDEX-MATCH 引用

### 2. 提高可读性
- 中间表清晰展示所有需求数据
- 易于审计和对账

### 3. 性能优化
- SUMIF 比 SUMPRODUCT 快得多
- 减少重复计算

### 4. 降低错误风险
- 公式更简单，不易出错
- ArrayFormula 对象问题已解决

---

## ✓ 验证数据（BA 为例）

### 源表数据
- **02_TrayPack_Order**: 4249.81 kg
  - Code 331: 190.17 kg
  - Code 2064: 794.08 kg
  - Code 2077: 195.03 kg
  - Code 200168: 3070.53 kg
  
- **03_BulkPack_Order**: 5400.00 kg
- **04_Bagging_Order**: 1070.99 kg
- **Total**: 10720.80 kg

### 验证方法
1. 打开 Excel 文件（公式会自动计算）
2. 查看 `14_Demand_Aggregation` 表
3. 对比 BA 行的数据：
   - TrayPack: 应为 4249.81 kg
   - BulkPack: 应为 5400.00 kg
   - Bagging: 应为 1070.99 kg
   - Total: 应为 10720.80 kg

---

## 📂 源表列位置参考

### 02_TrayPack_Order
- **P列**: Product_Group
- **R列**: WIP_kg

### 03_BulkPack_Order
- **K列**: Product_Group
- **N列**: WIP_kg

### 04_Bagging_Order
- **N列**: Product_Group
- **Q列**: WIP_kg

---

## 🔙 回滚方案

如需回滚到 v68：
1. 删除 `14_Demand_Aggregation` 工作表
2. 恢复 `14_Production_Planning` Row 30-38 的原 SUMPRODUCT 公式
3. 使用备份文件：`FINAL_v68_14ProductionPlanning_DEMAND_Formulas_2026-01-06.xlsx`

---

## 📝 后续建议

### 短期（可选）
1. 为其他需求类型创建类似中间表（例如：Opening WIP、Target End WIP）
2. 在 14_Demand_Aggregation 中添加数据验证规则

### 长期（已在 Roadmap）
1. 引入 Process BOM 层（v70）
2. 优化 Pool 分析逻辑

---

## 🚫 遵守的红线规则

✅ **未违反任何红线**：
- ✓ 未重命名任何工作表
- ✓ 未重命名任何字段/列名
- ✓ 未 refactor 全局代码
- ✓ 笼数聚合仍使用 MAX（未受影响）
- ✓ 未重新引入 Yield KPI

---

## 📄 文件清单

### 输入
- `FINAL_v68_14ProductionPlanning_DEMAND_Formulas_2026-01-06.xlsx`

### 输出
- `FINAL_v69_14DemandAggregation_IntermediateTable_2026-01-06.xlsx`

### 辅助文件
- `demand_aggregation.csv` (验证数据)
- `CHANGELOG_v69_2026-01-06.md` (本文档)
